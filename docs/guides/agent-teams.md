# Agent Teams ガイド

> 複数のClaude Codeインスタンスをチームとして協調動作させる**実験的機能**。

## 早見表

| 項目 | 内容 | 詳細 |
|---|---|:---:|
| 何ができるか | 複数Claudeがチームで協調作業 | [>>](#概要) |
| 既存機能との違い | Subagents/Worktreesとの比較 | [>>](#既存機能との違い) |
| 有効化の方法 | 環境変数を設定 | [>>](#有効化) |
| Delegate Modeとは | リードを調整専用に制限 | [>>](#delegate-mode) |
| どういうときに使うか | 具体的なユースケース | [>>](#ユースケース) |
| 注意点 | 制限事項とベストプラクティス | [>>](#制限事項とベストプラクティス) |

---

## 概要

1つのセッションが「チームリード」として機能し、複数の「チームメイト」にタスクを割り振る。各チームメイトは独立したコンテキストウィンドウを持ち、互いに直接メッセージのやり取りが可能。

### 構成要素

| コンポーネント | 役割 |
|---|---|
| Team Lead | チーム作成、タスク割り振り、結果統合 |
| Teammates | 独立したClaude Codeインスタンスとして各タスクを担当 |
| Task List | 全員で共有するタスクリスト（pending → in_progress → completed） |
| Mailbox | チームメイト間のメッセージングシステム |

---

## 既存機能との違い

| | Subagents | Agent Teams | Git Worktrees |
|---|---|---|---|
| コミュニケーション | 結果を返すだけ | チームメイト同士が直接やり取り | なし（完全独立） |
| 調整 | メインが全管理 | 共有タスクリストで自己調整 | ユーザーが手動 |
| 最適な用途 | 集中的な単発タスク | 議論・協力が必要な複雑作業 | 完全に独立した並列作業 |
| コスト | 低い | 高い（各チームメイトが別インスタンス） | 低い |

**使い分け:**
- 結果だけ返してほしい → **Subagents**
- チームメイト同士が議論・検証し合う必要がある → **Agent Teams**
- 完全に独立した作業を並列実行 → **Git Worktrees**

---

## 有効化

settings.json に追加:

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### 表示モード

| モード | 説明 | 必要なもの |
|---|---|---|
| in-process | メインターミナル内で動作。`Shift+Up/Down` でチームメイト切替 | 不要 |
| split-panes | 各チームメイトが独自のペインを持つ | tmux または iTerm2 |

**注意**: Split panesはVS Code統合ターミナル、Windows Terminal、Ghosttyでは非サポート。

---

## Delegate Mode

> リードを「調整専用」に制限するモード。

通常、リードはチームメイトを待たずに自分でコードを書き始めてしまうことがある。Delegate Modeを有効にすると、リードは以下のみ可能:
- チームメイトの生成・シャットダウン
- メッセージの送受信
- タスクの管理

コードには一切触れず、作業の分解・割り当て・統合に専念させる。

**有効化**: チーム開始後に `Shift+Tab` で切り替え。

---

## ユースケース

### 並列調査（互いに反証させる）

> バグの原因がわからない。複数の仮説を同時に検証したい。

```
ユーザーがメッセージ1通で切断される問題を調査して。
5人のチームメイトを生成して、それぞれ異なる仮説で調査させて。
互いの理論を反証し合い、合意された結論をドキュメントにまとめて。
```

順次調査ではアンカリングバイアスに陥りやすいが、複数の独立した調査者が互いに反証を試みることで、正しい原因に早く辿り着ける。

### 並列レビュー（観点を分ける）

> PRを多角的にレビューしたい。

```
PR #142をレビューするチームを作って。3人のレビュアーを生成:
- セキュリティの影響を確認する人
- パフォーマンスへの影響を確認する人
- テストカバレッジを検証する人
それぞれレビューして結果を報告させて。
```

### 多角的な設計検討

> 新機能の設計を複数の視点から検討したい。

```
TODOコメントを追跡するCLIツールを設計したい。
チームを作って異なる角度から検討させて:
- UX担当
- 技術アーキテクチャ担当
- 悪魔の代弁者（Devil's Advocate）
```

### クロスレイヤー開発

> フロントエンド・バックエンド・テストを並列で進めたい。

各チームメイトが異なるファイルセットを担当するように分割する。同じファイルを複数人が編集すると上書き事故になるので注意。

---

## 制限事項とベストプラクティス

### 制限事項

- **実験段階** — デフォルト無効。安定性は保証されていない
- セッションあたり **1チームのみ**
- チームメイトの **ネスト不可**（チームメイトが自分のチームを作れない）
- リードは **固定**（移譲・昇格不可）
- 同じファイルを複数人が編集すると **上書き事故**
- `/resume` や `/rewind` でチームメイトは **復元されない**
- **Windows Terminal 非サポート**（Split panes）

### ベストプラクティス

- **リサーチとレビューから始める** — コード変更を伴わない作業で慣れてから
- **タスクサイズを適切に** — 小さすぎると調整コストが上回る。大きすぎると制御を失う。1人5-6タスクが目安
- **ファイル競合を避ける** — 各チームメイトが異なるファイルセットを担当するよう分割
- **チームメイトの完了を待つ** — リードが先走る場合は `Wait for your teammates to complete their tasks before proceeding`
- **十分なコンテキストを渡す** — チームメイトはリードの会話履歴を引き継がない。スポーンプロンプトにタスク固有の詳細を含める

---

## 開発チーム テンプレート

specを起点にAgent Teamsで開発サイクルを回すためのテンプレート。

### ワークフロー

```
/spec（人 + Claude 1on1）→ spec承認
        ↓
/plan → plan + tasks + ARCHITECTURE.md作成
        ↓
★ 人がplan + ARCHITECTURE.mdをレビュー
        ↓
Agent Teams起動（spec + plan + tasks渡す）
        ↓
Phase 1: 実装 → レビュー → 改善（自律）
        ↓
Phase 2: 振り返り（PMが主導、全員で反省点を出す）
        ↓
★ 人が最終確認
```

★ = 人のチェックポイント。振り返りの学びは次回のAgent Teamsに引き継ぐ。

### チーム構成

| 役割 | モデル | 担当 | コード変更 |
|---|---|---|---|
| **PM**（Team Lead） | Opus | 全体指揮、優先度判断、タスク管理、ユーザーへの報告 | ❌（プロンプトで制限） |
| **デザイナー** | Sonnet | 色、フォント、余白、視覚的バランス | ❌ |
| **UI/UX** | Sonnet | 操作性、ユーザーフロー、フィードバック設計 | ❌ |
| **FEエンジニア** | Opus | コンポーネント実装、技術設計 | ✅ |
| **QA** | Sonnet | テスト作成、エッジケース検証、動作確認 | ✅（テストのみ） |

**ポイント**: PM・デザイナー・UI/UXはコードを触らない。実装はFEに集約してファイル競合を防ぐ。

### 起動プロンプト

Agent Teams起動時に以下をTeam Leadに渡す。`{spec_path}` を実際のパスに置き換える。

```
以下のspec・plan・tasksに基づいて開発チームを編成し、実装してください。

## チーム構成（4名のteammateを生成）

1. **デザイナー**（Sonnet） — 色、フォント、余白、視覚的バランスを担当。コード変更はしない。FEへの改善提案をメッセージで送る。
2. **UI/UX**（Sonnet） — 操作性、ユーザーフロー、フィードバック設計を担当。コード変更はしない。ユーザー視点の改善提案をFEへ送る。
3. **FEエンジニア**（Opus） — 唯一の実装担当。デザイナー・UI/UXの提案を受けてコードを書く。技術的に実現不可能な提案は理由とともに代替案を返す。
4. **QA**（Sonnet） — テスト作成と動作確認を担当。エッジケースの洗い出し、バグ報告をFEへ送る。テストコードのみ変更可。

## ワークフロー

### Phase 1: 実装サイクル
- spec, plan, tasks, ARCHITECTURE.md を全員で読む
- tasksに従ってFEが実装 → デザイナー・UI/UXがレビュー → QAがテスト → FEが修正
- このサイクルを全タスク完了まで繰り返す
- 完了したら最終成果物をユーザーに報告

### Phase 2: 振り返り
- PM（あなた）が各メンバーに聞く:「今回うまくいったこと、うまくいかなかったこと、次回の改善案」
- 結果を `{retro_path}` に記録する（プロジェクト固有の学びとテンプレート改善の提案を分けて記載）
- この記録は次回のAgent Teams起動時に参照される

## ルール
- あなた（PM）はコードファイルを編集しないこと。ファイルの読み取りと調整に専念する
- FE以外はコードファイルを直接編集しないこと
- QAはテストファイルのみ変更可
- チームメイト間の意見が対立した場合、PM（あなた）が判断する
- ユーザーへの報告はPM（あなた）経由で行う
- ARCHITECTURE.mdのアーキテクチャ原則に従うこと

## 入力ドキュメント
- Spec: {spec_path}
- Plan: {plan_path}
- Tasks: {tasks_path}
- Architecture: ARCHITECTURE.md

## 前回の振り返り（あれば）
{retro_path} があれば読んで、前回の学びを今回のチーム運営に活かしてください。なければスキップ。
```

### カスタマイズ

| 状況 | 変更 |
|---|---|
| BE不要（SPA） | 現状のまま（FEのみ） |
| API開発あり | **BEエンジニア**を追加。FEとファイル領域を分割（`src/` vs `api/`） |
| デザイン不要 | デザイナーを削除、UI/UXに統合 |
| テスト不要 | QAを削除 |

---

## 出典

- [Agent Teams 公式ドキュメント](https://code.claude.com/docs/en/agent-teams)
- [Best Practices](https://code.claude.com/docs/en/best-practices)
